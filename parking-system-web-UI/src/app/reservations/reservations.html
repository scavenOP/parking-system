<section class="reservations-section">
  <div class="container">
    <div class="section-header">
      <h2>My Reservations</h2>
      <div class="filter-tabs">
        <button 
          class="filter-tab" 
          [class.active]="selectedFilter === 'all'"
          (click)="selectedFilter = 'all'; filterBookings()">
          All
        </button>
        <button 
          class="filter-tab" 
          [class.active]="selectedFilter === 'active'"
          (click)="selectedFilter = 'active'; filterBookings()">
          Active
        </button>
        <button 
          class="filter-tab" 
          [class.active]="selectedFilter === 'in_progress'"
          (click)="selectedFilter = 'in_progress'; filterBookings()">
          In Progress
        </button>
        <button 
          class="filter-tab" 
          [class.active]="selectedFilter === 'completed'"
          (click)="selectedFilter = 'completed'; filterBookings()">
          Completed
        </button>
        <button 
          class="filter-tab" 
          [class.active]="selectedFilter === 'cancelled'"
          (click)="selectedFilter = 'cancelled'; filterBookings()">
          Cancelled
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Loading your reservations...</p>
    </div>

    <!-- Reservations List -->
    <div class="reservations-list" *ngIf="!isLoading && filteredBookings.length > 0">
      <div class="reservation-card" *ngFor="let booking of filteredBookings" [@fadeInUp]>
        <div class="reservation-header">
          <div class="space-info">
            <h4>Space {{booking.spaceId.spaceNumber}}</h4>
            <span class="floor-badge">Floor {{booking.spaceId.floor}}</span>
          </div>
          <div class="status-badge" [ngClass]="booking.status">
            {{booking.status | titlecase}}
          </div>
        </div>
        
        <!-- Show QR ticket for active bookings -->
        <div class="qr-ticket" *ngIf="booking.status === 'active' && booking.paymentStatus === 'completed'">
          <img [src]="getTicketQR(booking._id)" alt="QR Ticket" class="qr-code" *ngIf="ticketQRs[booking._id]">
          <button class="btn-show-qr" (click)="loadTicket(booking._id)" *ngIf="!ticketQRs[booking._id]">
            ðŸŽ« Show QR Ticket
          </button>
        </div>
        
        <div class="reservation-header">
        </div>

        <div class="reservation-details">
          <div class="detail-row">
            <span class="label">Vehicle:</span>
            <span class="value">{{booking.carId.make}} {{booking.carId.model}} - {{booking.carId.licensePlate}}</span>
          </div>
          <div class="detail-row">
            <span class="label">Start Time:</span>
            <span class="value">{{formatDateTime(booking.startTime)}}</span>
          </div>
          <div class="detail-row">
            <span class="label">End Time:</span>
            <span class="value">{{formatDateTime(booking.endTime)}}</span>
          </div>
          <div class="detail-row">
            <span class="label">Duration:</span>
            <span class="value">{{calculateDuration(booking.startTime, booking.endTime)}} hours</span>
          </div>
          <div class="detail-row">
            <span class="label">Amount:</span>
            <span class="value amount">â‚¹{{booking.totalAmount}}</span>
          </div>
          <div class="detail-row">
            <span class="label">Booked On:</span>
            <span class="value">{{formatDateTime(booking.createdAt)}}</span>
          </div>
        </div>

        <div class="reservation-actions">
          <!-- Payment retry for pending/failed payments (not cancelled) -->
          <button 
            *ngIf="(booking.paymentStatus === 'pending' || booking.paymentStatus === 'failed') && booking.status !== 'cancelled'"
            class="btn-pay" 
            (click)="retryPayment(booking._id)"
            [disabled]="isProcessingPayment">
            <span *ngIf="!isProcessingPayment">ðŸ’³ Complete Payment</span>
            <span *ngIf="isProcessingPayment">Processing...</span>
          </button>
          
          <!-- Cancel for active bookings -->
          <button 
            *ngIf="booking.status === 'active'"
            class="btn-cancel" 
            (click)="cancelBooking(booking._id)"
            [disabled]="isCancelling">
            <span *ngIf="!isCancelling">Cancel Reservation</span>
            <span *ngIf="isCancelling">Cancelling...</span>
          </button>
          
          <!-- Show status info for in_progress bookings -->
          <div *ngIf="booking.status === 'in_progress'" class="status-info">
            <p>ðŸš— Parking session active until {{formatDateTime(booking.endTime)}}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoading && filteredBookings.length === 0">
      <div class="empty-icon">ðŸ“…</div>
      <h3>No {{selectedFilter === 'all' ? '' : selectedFilter}} reservations found</h3>
      <p *ngIf="selectedFilter === 'all'">You haven't made any parking reservations yet.</p>
      <p *ngIf="selectedFilter !== 'all'">You don't have any {{selectedFilter}} reservations.</p>
      <a routerLink="/parking-search" class="btn-primary">Book Your First Spot</a>
    </div>
  </div>
</section>

<app-loading></app-loading>